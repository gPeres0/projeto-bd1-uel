<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Meu Desempenho</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 900px; margin: 0 auto; }
        .card-container { display: flex; gap: 20px; margin-top: 30px; justify-content: space-between; }
        .card { 
            flex: 1; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            background: white; text-align: center;
        }
        .card h3 { margin-top: 0; color: #555; }
        .card .nota-destaque { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card.melhor { border-top: 5px solid #28a745; }
        .card.pior { border-top: 5px solid #dc3545; }
        .chart-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Meu Hist√≥rico de Rendimento</h2>
    <a th:href="@{/dashboard}">‚¨Ö Voltar ao Menu</a>
    <hr/>

    <div class="chart-box">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="card-container" th:if="${melhorTema != null}">
        
        <div class="card melhor">
            <h3>üèÜ Melhor Desempenho</h3>
            <div style="color: #28a745; font-weight: bold;" th:text="${melhorTema.tema}">Matem√°tica</div>
            <div class="nota-destaque" th:text="${melhorTema.mediaNota}">9.5</div>
            <p>M√©dia Geral</p>
            <small>Question√°rios resolvidos: <span th:text="${melhorTema.totalQuestionarios}">5</span></small>
        </div>

        <div class="card pior">
            <h3>‚ö†Ô∏è Precisa Melhorar</h3>
            <div style="color: #dc3545; font-weight: bold;" th:text="${piorTema.tema}">Hist√≥ria</div>
            <div class="nota-destaque" th:text="${piorTema.mediaNota}">4.2</div>
            <p>M√©dia Geral</p>
            <small>Question√°rios resolvidos: <span th:text="${piorTema.totalQuestionarios}">3</span></small>
        </div>

    </div>
    
    <div th:unless="${melhorTema != null}" style="text-align: center; margin-top: 30px;">
        <p>Voc√™ ainda n√£o resolveu question√°rios suficientes para gerar estat√≠sticas.</p>
    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // 1. Recupera os dados enviados pelo Java (Thymeleaf injeta aqui como JSON)
    var dadosRaw = /*[[${dadosGrafico}]]*/ [];

    // 2. Processamento dos dados para o Chart.js
    // Precisamos agrupar por TEMA
    
    var temasSet = new Set();
    var datasSet = new Set();
    var dadosPorTema = {};

    dadosRaw.forEach(function(item) {
        temasSet.add(item.tema);
        datasSet.add(item.data);
        
        if (!dadosPorTema[item.tema]) {
            dadosPorTema[item.tema] = [];
        }
        dadosPorTema[item.tema].push({x: item.data, y: item.nota});
    });

    // Converte datasSet para array para usar como labels do eixo X
    var labels = Array.from(datasSet); 
    
    // Cria os datasets (linhas)
    var datasets = [];
    var cores = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2']; // Paleta de cores simples
    var corIndex = 0;

    temasSet.forEach(function(tema) {
        datasets.push({
            label: tema,
            data: dadosPorTema[tema],
            borderColor: cores[corIndex % cores.length],
            backgroundColor: cores[corIndex % cores.length],
            fill: false,
            tension: 0.1 // Suaviza√ß√£o da linha
        });
        corIndex++;
    });

    // 3. Renderiza o Gr√°fico
    var ctx = document.getElementById('meuGrafico').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // Eixo X (Datas)
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10, // Nota m√°xima √© 10
                    title: { display: true, text: 'Nota Obtida' }
                },
                x: {
                    title: { display: true, text: 'Data da Resolu√ß√£o' }
                }
            },
            plugins: {
                title: { display: true, text: 'Evolu√ß√£o por Tema ao Longo do Tempo' }
            }
        }
    });

    /*]]>*/
</script>

</body>
</html>